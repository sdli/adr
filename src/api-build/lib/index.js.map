{"version":3,"sources":["../../api/lib/index.js"],"names":["port","apiPort","loginStart","req","res","next","sess","session","body","username","password","code","parseInt","pngNum","json","codeErrorResponse","post","url","getServerUrl","JSON","stringify","phone","header","err","httpResponse","result","parse","token","data","tokenInfo","userInfo","expire","Date","reloadResponse","InitFetch","met","vali","method","validator","tryToken","initData","realToken","headers","toLowerCase","Object","assign","response","requestUrl","getUrl","mothod","pipe","catch","fetchUrl","type","func","organId","level","loginUserId","childId","id","orgId","beginTime","endTime","loadAuth","loginStatus","msg","setHeader","listen","error","console","info","loadImg","Math","random","p","color","img","getBase64","imgbase64","Buffer","writeHead","end","logout","download","funcs","countryList","countryReport","villageReport","getChildDetails","shenhe","searchChildren","changePassword","countryCheckReport","villageCheckList","initFetch","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["import config from \"../utils/configs\";\nimport fetchRequest from \"../utils/request\";\nimport date from \"../utils/date\";\nimport request from \"request\";\nimport captchapng from 'captchapng';\nimport co from 'co';\n\nvar port = config.apiPort;\n\n/**\n * è¯·æ±‚ç™»å½•æ¥å£\n * @param {è¯·æ±‚å†…å®¹} req \n * @param {è¿”å›å†…å®¹} res \n */\nfunction loginStart(req, res,next) {\n    let sess = req.session;\n    let { username, password ,code} = req.body;\n    if(parseInt(code) != parseInt(sess.pngNum)){\n        res.json(config.codeErrorResponse);\n        return true;\n    }\n    if (username && password ) {\n        request.post({\n            url: config.getServerUrl('login'),\n            body: JSON.stringify({\n                phone: username,\n                password: password\n            }),\n            header: {\n                \"Content-type\": \"application/json;charset=UTF-8\"\n            }\n        }, function(err, httpResponse, body) {\n            try{\n                let result = JSON.parse(body);\n                if (result.code == \"200\") {\n                    sess.username = username;\n                    sess.password = password;\n                    sess.token = result.data.tokenInfo.token;\n                    sess.userInfo = result.data;\n                    // sess.expire = Date.parse(new Date()) / 1000 + result.data.tokenInfo.expireTime - 300;\n                    sess.expire = Date.parse(new Date()) / 1000 + 10;\n                    res.json(result);\n                }else{\n                    res.json(config.reloadResponse);\n                }\n            }catch(err){\n                if(err){\n                    res.json(config.reloadResponse);\n                }\n            }\n        });\n    } else {\n        res.json(config.reloadResponse);\n    }\n}\n\n\n/**\n * æ¥å£questæ–¹æ³•è·å–å°è£…ï¼Œä¸€æ¬¡callback\n * @param {*è¯·æ±‚å‚æ•°} req \n * @param {*è¯·æ±‚å‚æ•°} res \n */\nconst InitFetch = function(met,url,vali) {\n        const method = met;\n        const validator = (typeof vali !== \"undefined\" || vali != null)?vali:null;\n        const tryToken = function(req) {\n            var sess = req.session;\n            var { username, password, token, expire } = sess;\n            if (username && password && token && expire) {\n                if (parseInt(expire) > Date.parse(new Date()) / 1000) {\n                    return token;\n                } else {\n                    return false;\n                }\n            }\n        };\n        return function(req,res,initData){\n            co(function*(){\n                var realToken = tryToken(req);\n                var sess = req.session;\n                if (!realToken) {\n                    var result = yield fetchRequest(config.getServerUrl('login'), {\n                        body: JSON.stringify({\n                            phone: sess.username,\n                            password: sess.password\n                        }),\n                        method: 'POST',\n                        headers: {\n                            \"Content-type\": \"application/json;charset=UTF-8\"\n                        }\n                    });\n                    if (typeof result.data.code !== \"undefined\") {\n                        if(result.data.code == \"200\"){\n                            sess.token = result.data.data.tokenInfo.token;\n                            sess.userInfo = result.data.data;\n                            // sess.expire = Date.parse(new Date()) / 1000 + result.data.tokenInfo.expireTime - 300;\n                            sess.expire = Date.parse(new Date()) / 1000 + 10;\n                            realToken = result.data.data.tokenInfo.token;  \n                        }\n                   }else{\n                        res.json(config.reloadResponse);\n                   }\n                }\n                if(method.toLowerCase() == \"post\"){\n                        request.post(Object.assign({\n                            body:JSON.stringify(initData)},\n                            {headers: {\n                                \"Content-type\": \"application/json\",\n                                \"authorization\": realToken\n                            },\n                            url: url\n                        }),function(err,response,body){\n                                let result = JSON.parse(body);\n                                if(result.code == \"200\"){\n                                    if(validator){\n                                        validator(result,req,res);\n                                    }else{\n                                        res.json(result);\n                                    }\n                                }else{\n                                    res.json(config.reloadResponse);\n                                }   \n                        });\n                }else{\n                    let requestUrl = getUrl(req,url);\n                    try{\n                        request({\n                            mothod: \"GET\",\n                            url: requestUrl,\n                            headers:{\n                                \"authorization\": realToken\n                            }\n                        }).pipe(res);\n                    }catch(err){\n                        res.json(config.reloadResponse);\n                    }\n                }\n            }).catch((err)=>{\n                res.json(config.reloadResponse);  \n            });\n    }\n}\n\n/**\n * æ¥å£äºŒæ¬¡å°è£…ã€‚ç¬¬äºŒä¸ªcallback\n * @param {*æ¥å£ç±»å‹} type \n */\nfunction fetchUrl(mothod,type,func=null){\n    return InitFetch(mothod,config.getServerUrl(type),func);\n}\n\n/**\n * \n * @param {*æµ‹è¯•url} req \n */\nfunction getUrl(req,url){\n    let requestUrl=\"\";\n     switch (req.body.type){\n        case \"village\":\n            requestUrl = url+\"?orgId=\"+req.body.organId+\"&currPage=1&pageSize=100&currLevel=\"+req.body.level+\"&loginUserId=\"+req.body.loginUserId;\n            break;\n        case \"childDetails\":\n            requestUrl = url+\"?childId=\"+req.body.childId;\n            break;\n        case \"byRosterId\":\n            requestUrl = url+ \"?rosterId=\"+req.body.id;\n            break;\n        case \"byVillageId\":\n            requestUrl = url+ \"?villId=\" + req.body.id+\"&currLevel=\" + req.body.level;\n            break;\n        case \"byOrgId\":\n            requestUrl = url + \"?orgId=\" + req.body.id+\"&currLevel=\"+ req.body.level;\n            break;\n        case \"tableList\":\n            requestUrl = url + req.body.organId;\n            break;\n        case \"searchChildren\":\n            requestUrl = url + \"?orgId=\" + req.body.orgId + \"&level=\"+ req.body.level+ \"&currPage=1&pageSize=100&uid=\"+req.body.id\n            break;\n        case \"checkReport\":\n            requestUrl = url + \"?orgId=\" + req.body.organId + \"&beginTime=\" + req.body.beginTime + \"&endTime=\" + req.body.endTime;\n            break;\n        case \"villageCheckList\":\n            requestUrl = url + \"?orgId=\" + req.body.organId + \"&beginTime=\" + req.body.beginTime + \"&endTime=\" + req.body.endTime;\n            break;\n        case \"byOrgIdForCheck\":\n            requestUrl = url + \"?orgId=\" + req.body.id+\"&beginTime=\"+ req.body.beginTime+\"&endTime=\"+req.body.endTime;\n            break;\n        case \"byVillageIdForCheck\":\n            requestUrl = url + \"?orgId=\" + req.body.id+\"&beginTime=\"+ req.body.beginTime+\"&endTime=\"+req.body.endTime;\n            break;\n        default:\n            requestUrl = url + \"?orgId=\"+req.body.organId + \"&currLevel=\"+req.body.level\n    }\n    return requestUrl;\n}\n\n/**\n * åŠ è½½è®¤è¯\n * @param {*å¤„ç†è¯·æ±‚} req \n * @param {*å¤„ç†è¿”å›æ•°æ®} res \n * @param {*} next \n */\nfunction loadAuth(req, res, next) {\n    let loginStatus = (typeof req.session.username === \"undefined\" || typeof req.session.password === \"undefined\" || !req.session.username || !req.session.password) ? false : true;\n    if (loginStatus) {\n        let result = {\n            code: '1',\n            userInfo: req.session.userInfo,\n            msg: 'login auth OK!'\n        };\n        res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n        res.setHeader(\"Content-Type\", \"application/json\");\n        res.json(result);\n    } else {\n        let result = {\n            code: '0',\n            msg: 'no auth!'\n        };\n        res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n        res.setHeader(\"Content-Type\", \"application/json\");\n        res.json(result);\n    }\n}\n\n\n/**\n * ç›‘å¬ç«¯å£å·\n * @param {é”™è¯¯} error \n */\nfunction listen(error) {\n    if (error) {\n        console.error(error)\n    } else {\n        console.info(\"==> ğŸŒ  API listening on port %s.\", port, port)\n    }\n}\n\nfunction loadImg(req,res,next){\n    var pngNum = parseInt(Math.random()*9000+1000);\n    req.session.pngNum = pngNum;\n    var p = new captchapng(80,30,parseInt(pngNum)); // width,height,numeric captcha \n    p.color(0, 0, 0, 0);  // First color: background (red, green, blue, alpha) \n    p.color(80, 80, 80, 255); // Second color: paint (red, green, blue, alpha) \n\n    var img = p.getBase64();\n    var imgbase64 = new Buffer(img,'base64');\n    res.writeHead(200, {\n        'Content-Type': 'image/png'\n    });\n    res.end(imgbase64);\n}\n\n/**\n * è¯·æ±‚ç™»å‡º\n * @param {è¯·æ±‚å†…å®¹} req \n * @param {è¿”å›å†…å®¹} res \n * @param {ä¼ é€’æ–¹æ³•} next \n */\nfunction logout(req,res,next){\n    req.session.username = null;\n    req.session.password = null;\n    let result = {\n        \"code\":1,\n        \"msg\": \"logout succ\"\n    };\n    res.json(result);\n}\n\n/**\n * ä¸‹è½½æ¥å£\n */\nfunction download(req,res){\n    let type = req.body.type;\n    switch (type){\n        case \"byRosterId\":  fetchUrl(\"get\",\"downloadChild\")(req,res) ;break;\n        case \"byVillageId\":  fetchUrl(\"get\",\"downloadCountry\")(req,res); break;\n        case \"byOrgId\":  fetchUrl(\"get\",\"downloadOrg\")(req,res);break;\n        case \"byOrgIdForCheck\": fetchUrl(\"get\",\"downloadOrgForCheck\")(req,res);break;\n        case \"byVillageIdForCheck\": fetchUrl(\"get\",\"downloadCountryForCheck\")(req,res);break;\n        default:  res.json(config.reloadResponse);\n    }\n}\n\n/**\n * exportæ•´åˆ\n */\nconst funcs = {\n    countryList: fetchUrl(\"get\",\"countryList\"),\n    countryReport: fetchUrl(\"get\",\"countryReport\"),\n    villageReport: fetchUrl(\"get\",\"villageReport\"),\n    getChildDetails: fetchUrl(\"get\",\"getChildDetails\"),\n    shenhe: fetchUrl(\"post\",\"shenhe\"),\n    searchChildren:fetchUrl(\"get\",\"searchChildren\"),\n    changePassword: fetchUrl(\"post\",\"changePassword\"),\n    countryCheckReport: fetchUrl(\"get\",\"countryCheckReport\"),\n    download: download,\n    villageCheckList: fetchUrl(\"get\",\"villageCheckList\"),\n    loginStart: loginStart,\n    initFetch: InitFetch,\n    loadAuth: loadAuth,\n    listen: listen,\n    loadImg: loadImg,\n    logout: logout\n};\n\nmodule.exports = funcs;"]}